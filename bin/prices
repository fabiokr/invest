#! /usr/bin/env ruby

require "json"
require "net/http"
require_relative "../lib/invest"

CATEGORIES = %w(Acoes FI)

date = Date.today

query = Invest.new.events_query
output = []

def get_price(asset)
  content = Net::HTTP.get(URI("http://cotacoes.economia.uol.com.br/acao/cotacoes-historicas.html?codigo=#{asset}.SA"))

  if match = %r{<td class="ultima">(.+)?</td>}.match(content)
    match[1]
  else
    raise ArgumentError, "No quotes for #{asset}"
  end
end

query.categories.each do |category, assets|
  next unless CATEGORIES.include?(category)

  assets.each do |asset|
    next unless query.asset_month_show?(asset, date.year, date.month)

    puts "Checking #{asset}"

    output << %Q{#{date.to_s},#{asset},#{category},"#{get_price(asset)}"}
  end
end

puts output
